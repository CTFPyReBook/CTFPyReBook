<!DOCTYPE HTML>
<html lang="cn" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <meta name="msvalidate.01" content="38A57868CBC8F90FB6CEEC0F11CFCA2C" />
        <meta name="google-site-verification" content="-UwBRfWTwjuPwGqQ3KnINva5qwsb6mfO1OBFouNBdfY" />
        <title>PyTypeObject - CTFPython逆向入门</title>


        <!-- Custom HTML head -->

        <meta name="description" content="CTF中常见的python逆向入门教程">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">CTFPython逆向入门</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/CTFPyReBook/CTFPyReBook" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="pytypeobject"><a class="header" href="#pytypeobject">PyTypeObject</a></h1>
<blockquote>
<p>本部分内容包含直接转载引用内容，如有侵权请通知</p>
</blockquote>
<h2 id="类型对象用于保存某类型信息的结构体"><a class="header" href="#类型对象用于保存某类型信息的结构体">类型对象（用于保存某类型信息的结构体）</a></h2>
<p><code>PyTypeObject</code> 是 Python C API 中的一个核心结构体，用于表示 Python 中的类型。每个 Python 对象都有一个类型，而这个类型就是由 <code>PyTypeObject</code> 结构体表示的。</p>
<h3 id="结构定义"><a class="header" href="#结构定义">结构定义</a></h3>
<p><code>PyTypeObject</code> 结构体的定义如下：</p>
<pre><code class="language-c">typedef struct _typeobject {
    PyObject_VAR_HEAD
    const char *tp_name; /* 类型名称 */
    Py_ssize_t tp_basicsize, tp_itemsize; /* 对象的基本大小和项大小 */
    /* 方法集 */
    destructor tp_dealloc;
    printfunc tp_print;
    getattrfunc tp_getattr;
    setattrfunc tp_setattr;
    /* ... 其他方法 ... */
    hashfunc tp_hash;
    /* 类型比较函数 */
    comparisonfunc tp_compare;
    /* 类型转换函数 */
    convertfunc tp_as_number;
    tp_as_sequence;
    tp_as_mapping;
    /* ... 其他属性 ... */
    struct _typeobject *tp_base; /* 基类 */
    PyObject *tp_dict; /* 类的字典 */
    /* ... 其他字段 ... */
} PyTypeObject;
</code></pre>
<h3 id="主要字段"><a class="header" href="#主要字段">主要字段</a></h3>
<ul>
<li><code>tp_name</code>：类型的名称，如 <code>"int"</code>, <code>"str"</code> 等。</li>
<li><code>tp_basicsize</code>：对象的基本大小（不包括可变部分）。</li>
<li><code>tp_itemsize</code>：如果类型表示一个数组或类似数组的对象，此字段表示每个项的大小。</li>
<li><code>tp_dealloc</code>：对象的析构函数。</li>
<li><code>tp_print</code>：对象的打印函数。</li>
<li><code>tp_getattr</code> 和 <code>tp_setattr</code>：对象的属性访问函数。</li>
<li><code>tp_hash</code>：对象的哈希函数。</li>
<li><code>tp_compare</code>：对象的比较函数。</li>
<li><code>tp_as_number</code>, <code>tp_as_sequence</code>, <code>tp_as_mapping</code>：对象作为数字、序列、映射时的操作函数。</li>
<li><code>tp_base</code>：基类类型对象。</li>
<li><code>tp_dict</code>：类型的命名空间字典，包含类型的属性和方法。</li>
</ul>
<h3 id="动态类型系统"><a class="header" href="#动态类型系统">动态类型系统</a></h3>
<p>Python 的类型系统是动态的，允许在运行时创建和修改类型。通过 <code>PyTypeObject</code> 结构体，Python C API 提供了创建新类型、修改现有类型以及查询类型信息的接口。</p>
<h2 id="pytypenameobject"><a class="header" href="#pytypenameobject">Py(Typename)Object</a></h2>
<p>其中(Typename)是可以替换位类型名称，比如int类型可以替换为PyLongObject，他们才是真正存放变量信息的结构体</p>
<blockquote>
<p><strong>Py(Typename)Object和PyTypeObject的区别</strong></p>
<p><code>PyLongObject</code> 是一种具体的对象类型，而 <code>PyTypeObject</code> 则描述了这种类型的元数据。具体关系如下：</p>
<ul>
<li><strong>类型描述</strong>: <code>PyLongObject</code> 的 <code>ob_type</code> 字段指向 <code>PyLong_Type</code>，这是一个 <code>PyTypeObject</code> 实例。<code>PyLong_Type</code> 定义了长整数的所有属性和方法，例如加法、减法、乘法等操作。</li>
<li><strong>继承关系</strong>: 在 Python 的类型体系中，所有的对象都继承自 <code>PyObject</code>，而 <code>PyObject</code> 包含一个指向 <code>PyTypeObject</code> 的指针。<code>PyLongObject</code> 继承自 <code>PyObject</code>，因此它也有一个 <code>ob_type</code> 字段指向其类型对象 <code>PyLong_Type</code>。</li>
<li><strong>动态类型系统</strong>: Python 的动态类型系统依赖于 <code>PyTypeObject</code> 来在运行时确定对象的类型，并调用相应的操作。当你对一个长整数进行操作时，Python 会通过 <code>ob_type</code> 找到 <code>PyLong_Type</code>，然后调用其定义的方法来执行操作。</li>
</ul>
</blockquote>
<h2 id="用c创建一个python的类型"><a class="header" href="#用c创建一个python的类型">用C创建一个Python的类型</a></h2>
<p>以下是一个简单的示例，展示如何使用 <code>PyTypeObject</code> 创建一个新的 Python 类型：</p>
<p>我们先根据结构的声明我们的新类型</p>
<pre><code class="language-python">#include &lt;Python.h&gt;

typedef struct {
    PyObject_HEAD
    int value;
} MyIntObject;

static PyTypeObject MyIntType = {
    PyVarObject_HEAD_INIT(NULL, 0)
    .tp_name = "myint.MyInt",
    .tp_basicsize = sizeof(MyIntObject),
    .tp_flags = Py_TPFLAGS_DEFAULT,
    .tp_new = MyInt_new,
    .tp_init = (initproc)MyInt_init,
    .tp_members = MyInt_members,
};
</code></pre>
<p>如何在结构体后跟上我们新创建类型的方法</p>
<pre><code class="language-c">static PyObject* MyInt_new(PyTypeObject *type, PyObject *args, PyObject *kwds) {
    MyIntObject *self;
    self = (MyIntObject *)type-&gt;tp_alloc(type, 0);
    if (self != NULL) {
        self-&gt;value = 0;
    }
    return (PyObject *)self;
}

static int MyInt_init(MyIntObject *self, PyObject *args, PyObject *kwds) {
    static char *kwlist[] = {"value", NULL};
    if (!PyArg_ParseTupleAndKeywords(args, kwds, "i", kwlist, &amp;self-&gt;value))
        return -1;
    return 0;
}

static PyMemberDef MyInt_members[] = {
    {"value", T_INT, offsetof(MyIntObject, value), 0, "integer value"},
    {NULL}  /* Sentinel */
};



static PyModuleDef myintmodule = {
    PyModuleDef_HEAD_INIT,
    .m_name = "myint",
    .m_doc = "Example module that creates an extension type",
    .m_size = -1,
};

</code></pre>
<p>加载类型</p>
<pre><code class="language-python">PyMODINIT_FUNC PyInit_myint(void) {
    PyObject *m;
    if (PyType_Ready(&amp;MyIntType) &lt; 0)
        return NULL;
    m = PyModule_Create(&amp;myintmodule);
    if (m == NULL)
        return NULL;
    Py_INCREF(&amp;MyIntType);
    PyModule_AddObject(m, "MyInt", (PyObject *)&amp;MyIntType);
    return m;
}
</code></pre>
<h2 id="pytype_type类型的类型"><a class="header" href="#pytype_type类型的类型">PyType_Type，类型的类型</a></h2>
<p>我们初步考察了 <em>float</em> 类型对象，知道它在 <em>C</em> 语言层面是 <em>PyFloat_Type</em> 全局静态变量。 类型是一种对象，它也有自己的类型，也就是 <em>Python</em> 中的 <em>type</em> ：</p>
<pre><code class="language-python">&gt;&gt;&gt; float.__class__
&lt;class 'type'&gt;
</code></pre>
<p>那么， <em>type</em> 在 <em>C</em> 语言层面又长啥样呢？</p>
<p>围观 <em>PyFloat_Type</em> 时，我们通过 <em>ob_type</em> 字段揪住了 <em>PyType_Type</em> 。 的确，它就是 <em>type</em> 的肉身。 <em>PyType_Type</em> 在 <em>Object/typeobject.c</em> 中定义：</p>
<pre><code class="language-c">PyTypeObject PyType_Type = {
    PyVarObject_HEAD_INIT(&amp;PyType_Type, 0)
    "type",                                     /* tp_name */
    sizeof(PyHeapTypeObject),                   /* tp_basicsize */
    sizeof(PyMemberDef),                        /* tp_itemsize */
    (destructor)type_dealloc,                   /* tp_dealloc */

    // ...
    (reprfunc)type_repr,                        /* tp_repr */

    // ...
};
</code></pre>
<p>内建类型和自定义类对应的 <em>PyTypeObject</em> 对象都是这个通过 <em>PyType_Type</em> 创建的。 <em>PyType_Type</em> 在 <em>Python</em> 的类型机制中是一个至关重要的对象，它是所有类型的类型，称为 <strong>元类型</strong> ( <em>meta class</em> )。 借助元类型，你可以实现很多神奇的高级操作。</p>
<p>注意到， <em>PyType_Type</em> 将自己的 <em>ob_type</em> 字段设置成它自己(第 <em>2</em> 行)，这跟我们在 <em>Python</em> 中看到的行为是吻合的：</p>
<pre><code class="language-python">&gt;&gt;&gt; type.__class__
&lt;class 'type'&gt;
&gt;&gt;&gt; type.__class__ is type
True
</code></pre>
<p>至此，元类型 <em>type</em> 在对象体系里的位置非常清晰了：</p>
<p><img src="2.1PyTypeObject.assets/969eee907565126784ae11d0a5febd2108174058.png" alt="img" /></p>
<h2 id="pybaseobject_type类型之基"><a class="header" href="#pybaseobject_type类型之基">PyBaseObject_Type，类型之基</a></h2>
<p><img src="2.1PyTypeObject.assets/5f3e61a13ebb012c523116be1dc7978e152f48b9.png" alt="img" /></p>
<h2 id="引用"><a class="header" href="#引用">引用</a></h2>
<blockquote>
<p><a href="https://fasionchan.com/python-source/object-model/pyobject/#pybaseobject_type">类型之基</a></p>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="2.0Python和C对接的类型.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="2.2PyObject.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="2.0Python和C对接的类型.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="2.2PyObject.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
